<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0">
    <link href="css/style.css" rel="stylesheet">
    <link href="css/animate.min.css" rel="stylesheet" type="text/css">
    <link href="css/index.css" rel="stylesheet">
    <link href="css/main.css" rel="stylesheet">
    <style>

    </style>
    <title>智慧城市</title>
</head>
<body>
<section id="loading">
    <div>

        <span></span>
        <span></span>
        <span></span>
        <a></a>
    </div>
</section>
<section class="scene scene-index"></section>
<section class="scene scene-main"></section>
</body>
<footer>
    <script src="js/zepto.min.js"></script>
    <script src="js/index.js"></script>
    <script src="js/main.js"></script>
</footer>
</html>
<script>
    $(function() {
        var win = $(window);
        var load_sum=0,load_n=0;
        (function (scenes) {
            for (var i = 0; i < scenes.length; i++) {
                (function (scene) {
                    scene = $.extend({
                        'path':'',
                        'auto_w':true,                         /*是否自动适应宽度*/
                        'auto_h':true,                         /*是否自动适应高度*/
                        'layers':[]                             /*场景的图层数据*/
                    },scene)
                    var sw, sh;                                 /*记录长和宽的比例*/
                    for (var j = 0; j < scene.layers.length; j++) {
                        (function (layer) {
                            if (!layer.attr) layer.attr = {}
                            layer.attr.class = (layer.attr && layer.attr.class) ? layer.attr.class + ' layer' : 'layer';
                            var obj = $('<' + (layer.tag ? layer.tag : 'div') + '/>').attr(layer.attr).css(layer.css);
                            var w, h;
                            if (layer.img) {
                                var img = new Image();
                                img.src = scene.path + layer.img;
                                load_sum++;
                                img.onload = function () {
                                    obj.css('background-image', 'url('+ scene.path + layer.img + ')');
                                    w = layer.w?layer.w:img.width;
                                    h = layer.h?layer.h:img.height;
                                    obj.css({'width': w, 'height': h});
                                    load_n++;
                                    if(loading())win.resize();
                                }
                            } else {
                                w = layer.w;
                                h = layer.h;
                                obj.css({'width': w, 'height': h});
                            }
                            scene.box.append(obj);
                            var autoSize;
                            if (!scene.auto_h && scene.auto_w) obj.bind('autoSize', function autoSizeW() {
                                obj.css({'width': w * sw, 'left': layer.x * sw, 'height': h * sw, 'top': layer.y * sw});
                            });
                            else if (scene.auto_h && !scene.auto_w) obj.bind('autoSize', function autoSizeH() {
                                obj.css({'width': w * sh, 'left': layer.x * sh, 'height': h * sh, 'top': layer.y * sh});
                            });
                            else if (scene.auto_h && scene.auto_w) obj.bind('autoSize', function autoSizeAll() {
                                obj.css({'width': w * sw, 'left': layer.x * sw, 'height': h * sh, 'top': layer.y * sh});
                            });
                        })(scene.layers[j])
                    }

                    function resize() {
                        if(scene.box.is('.show')){
                            sw = win.width() / scene.width;
                            sh = win.height() / scene.height;
                            scene.box.children('.layer').trigger('autoSize');
                        }
                    }
                    win.resize(resize);                         /*重设窗体大小*/
                })(scenes[i])
            }
        })([scene_index,scene_main]);

        function loading(){
            $("#loading a").text((load_n/load_sum).toFixed(2)*100+"%");
            if(load_n == load_sum){
                $('.scene.scene-index').addClass('show')
                $("#loading").remove();
                for(var i=0;i<bindfun.length;i++){
                    var fun = bindfun[i];
                    if(fun)fun();
                }
                return true;
            }
            return false;
        }
    })
</script>
<div id="orientLayer" class="mod-orient-layer">
    <div class="mod-orient-layer__content">
        <i class="icon mod-orient-layer__icon-orient"></i>
        <div class="mod-orient-layer__desc">为了更好的体验，请使用横屏浏览</div>
    </div>
</div>